<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="comboio.css"/>
    <script type='text/javascript' src="../node_modules/lodash/lodash.min.js"></script>
    <script type='text/javascript' src="../node_modules/@svgdotjs/svg.js/dist/svg.min.js"></script>
    <script type="text/javascript" src="../node_modules/microsoft-cognitiveservices-speech-sdk/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    <script type="text/javascript" src="../node_modules/modern-async/dist/modern-async.umd.js"></script>
    <script type="text/javascript" src="../node_modules/luxon/build/global/luxon.min.js"></script>
    <script type='text/javascript' src="led.js"></script>
    <script type="text/javascript">
      const follower = nodecg.Replicant('follower');
      const subscriber = nodecg.Replicant('subscriber');
      const cheer = nodecg.Replicant('cheer');
      const track = nodecg.Replicant('track');
      const counters = nodecg.Replicant('counters');

      const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(nodecg.bundleConfig.tts.speechKey, nodecg.bundleConfig.tts.region);
      speechConfig.speechSynthesisVoiceName = nodecg.bundleConfig.tts.voiceName;
      const tee = new Audio("media/tee.ogg");
      tee.volume = 0.5;
      const alertQueue = new modernAsync.Queue(1);

      document.addEventListener('DOMContentLoaded', async () => {
        const panelFollower = new LEDPanel('#display-follower', 10, 4, 5);
        const panelSubscriber = new LEDPanel('#display-subscriber', 10, 4, 5);
        const panelCheer = new LEDPanel('#display-cheer', 10, 4, 5);
        const panelTrack = new LEDPanel('#display-track', 10, 4, 5);
        const panelAlerts = new LEDPanel('#alerts', 25, 4, 5);
        const panelCounters = _.range(3).map(i => new LEDPanel(`#counter${i+1}`, 13, 5, 5));

        follower.on('change', value => {
          nodecg.log.debug('updated follower:', value);
          panelFollower.drawLoopable(value, 100);
        });

        subscriber.on('change', value => {
          nodecg.log.debug('updated subscriber:', value);
          panelSubscriber.drawLoopable(value.user_name, 100);
        });

        cheer.on('change', value => {
          nodecg.log.debug('updated cheer:', value);
          panelCheer.drawLoopable(`${value.user_name} (${value.bits})`, 100);
        });

        track.on('change', value => {
          if (alertQueue.running === 0) {
            if (value) {
              panelAlerts.drawLoopable(`Ouvindo: ${value}`, 50);
            } else {
              panelAlerts.clearAll();
            }
          }
        });

        nodecg.listenFor('alert', value => {
          alertQueue.exec(async () => {
            const tts = new SpeechSDK.SpeechSynthesizer(speechConfig);
            if (value.title) {
              tee.play();
              setTimeout(() => tts.speakTextAsync(value.title), 9000);
              await panelAlerts.drawScroll(value.title, 25);
            }
            if (value.user_name) {
              setTimeout(() => tts.speakTextAsync(value.user_name), 500);
              await panelAlerts.drawAndClearVertical(value.user_name, 250);
            }
            if (value.message) {
              setTimeout(() => tts.speakTextAsync(value.message), 250);
              await panelAlerts.drawScroll(value.message, 25);
            }
            tts.close();
            if (alertQueue.pending === 0 && track.value) {
              panelAlerts.drawLoopable(`Ouvindo: ${track.value}`, 50);
            }
          });
        });

        async function countdown(duration) {
          if (duration.valueOf() >= 0) {
            if (alertQueue.running === 0) {
              await panelAlerts.drawLoopable(`Próxima partida: ${duration.toFormat('mm:ss')}`, 25);
            }
            setTimeout(() => countdown(duration.minus(1000)), 1000);
          }
        }

        nodecg.listenFor('opening', seconds => {
          countdown(luxon.Duration.fromMillis(seconds*1000));
        });

        nodecg.listenFor('clear-alert', () => {
          panelAlerts.clearAll();
        });

        counters.on('change', value => {
          const visible = value.filter(counter => counter.show);
          for (let i = 0; i < 3; ++i) {
            const label = visible[i] ? `!${visible[i].command.padEnd(7)} ${visible[i].count.toString().padStart(4)}` : '';
            panelCounters[i].drawLoopable(label);
          }
        });
      });
    </script>
  </head>

  <body>
    <svg id="alerts"></svg>
    <svg id="counter1"></svg>
    <svg id="counter2"></svg>
    <svg id="counter3"></svg>
    <h3 id="label-follower">Último embarque</h3>
    <svg id="display-follower"></svg>
    <h3 id="label-subscriber">Último passe</h3>
    <svg id="display-subscriber"></svg>
    <h3 id="label-cheer">Últimos bits</h3>
    <svg id="display-cheer"></svg>
    <h3 id="label-track"></h3>
    <svg id="display-track"></svg>
  </body>
</html>
