<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="../node_modules/jsonform/deps/opt/bootstrap.css"></script>
  <script type="text/javascript" src="../node_modules/jsonform/deps/jquery.min.js"></script>
  <script type="text/javascript" src="../node_modules/jsonform/deps/opt/jquery-ui.js"></script>
  <script type="text/javascript" src="../node_modules/jsonform/deps/underscore.js"></script>
  <script type="text/javascript" src="../node_modules/jsonform/lib/jsonform.js"></script>
  <script type="text/javascript" src="../node_modules/obs-websocket-js/dist/obs-websocket.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Mock events</h2>
    <p>Only works if you start NodeCG with the MOCK_CHAT environment variable set</p>
    <button id="mock-sub">Subscription</button>
    <button id="mock-cheer">Cheer</button>
    <button id="mock-raid">Raid</button>
    <h2>Labels</h2>
    <form id="follower"></form>
    <form id="subscriber"></form>
    <form id="cheer"></form>
    <form id="goal"></form>
    <h2>Counters</h2>
    <form id="counters"></form>
  </div>
  <script type="text/javascript">
    const obs = new OBSWebSocket();
    obs.connect(nodecg.bundleConfig.obs);
    obs.on('SwitchScenes', event => {
        if (event['scene-name'] === nodecg.bundleConfig.opening.sceneName) {
            nodecg.sendMessage('opening', nodecg.bundleConfig.opening.duration);
        } else {
            nodecg.sendMessage('clear-alert'); // TODO find a way to cancel previous countdowns
        }
    });
    nodecg.listenFor('play', sourceName => {
        obs.send('RestartMedia', { sourceName });
    });

    function createLabelForm(el, label) {
      const replicant = nodecg.Replicant(label);
      replicant.on('change', value => {
        $(el).empty().jsonForm({
          schema: {
            [label]: { type: 'string' }
          },
          value: { [label]: value },
          onSubmitValid: values => {
            replicant.value = values[label];
          }
        });
      });
    }
    createLabelForm('#follower', 'follower');
    createLabelForm('#subscriber', 'subscriber');
    createLabelForm('#cheer', 'cheer');
    createLabelForm('#goal', 'goal');

    const counters = nodecg.Replicant('counters');
    counters.on('change', value => {
      $('#counters').empty().jsonForm({
        schema: {
          counters: {
            type: "array",
            items: {
              type: "object",
              properties: {
                command: { type: "string", title: "Command", required: true },
                message: { type: "string", title: "Message", description: "Use #### to replace with count" },
                count: { type: "integer", title: "Count", default: 0 },
                show: { type: "boolean", title: "Show on screen", required: true }
              }
            }
          }
        },
        form: [
          {
            key: "counters",
            notitle: true,
            items: {
              type: "section",
              items: [
                { key: "counters[].command", prepend: "!" },
                "counters[].message",
                "counters[].count",
                "counters[].show"
              ]
            }
          },
          {
            type: "submit",
            title: "Update"
          }
        ],
        value: { counters: value },
        onSubmitValid: values => {
          counters.value = values.counters;
        }
      });
    });

    $('#mock-sub').click(() => {
      nodecg.sendMessage('chat', 'subscription');
    });
    $('#mock-cheer').click(() => {
      nodecg.sendMessage('chat', 'bits');
    });
    $('#mock-raid').click(() => {
      nodecg.sendMessage('chat', 'raid');
    });
  </script>
</body>
</html>
